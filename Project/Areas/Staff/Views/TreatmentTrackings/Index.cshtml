@model IEnumerable<Project.Areas.Staff.Models.ViewModels.TreatmentTrackingViewModel>

@{
    ViewData["Title"] = "Danh sách theo dõi điều trị";
    Layout = "~/Views/Shared/_mainAdminLayout.cshtml";
}

<div class="overlay" id="loadingOverlay">
    <span
        class="animate-spin border-8 border-[#f1f2f3] border-l-primary rounded-full w-14 h-14 inline-block align-middle"></span>
</div>

<form id="indexForm" method="post" asp-action="MoveToTrash">
    @Html.AntiForgeryToken()
    <input type="hidden" name="selectedIds" id="selectedIds" />

    <ul class="flex space-x-2 rtl:space-x-reverse">
        <li>
            <a href="javascript:;" class="text-primary hover:underline">Theo dõi điều trị</a>
        </li>
        <li class="before:content-['/'] ltr:before:mr-1 rtl:before:ml-1">
            <span>Danh sách</span>
        </li>
    </ul>

    <div x-data="list">
        <div class="panel border-[#e0e6ed] px-0 dark:border-[#1b2e4b] mt-3">
            <div class="px-5">
                <div class="text-2xl font-bold mb-6">Danh sách theo dõi điều trị phòng:
                    @Model.FirstOrDefault()?.RoomName</div>
                <hr class="mb-6">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-5">
                    <div class="flex w-full flex-col gap-4 sm:w-auto sm:flex-row sm:items-center sm:gap-3">
                        <div>
                            <a href="javascript:;" id="btnAddTracking" class="btn btn-primary"
                                @@click = "openTrackingModal" >
                                <svg width="24" height="24" class="h-5 w-5 ltr:mr-2 rtl:ml-2" viewBox="0 0 24 24"
                                    fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                                    <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                                    <g id="SVGRepo_iconCarrier">
                                        <g id="Edit / Add_Plus_Circle">
                                            <path id="Vector"
                                                d="M8 12H12M12 12H16M12 12V16M12 12V8M12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21Z"
                                                stroke="#ffffff" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round"></path>
                                        </g>
                                    </g>
                                </svg>
                                Thêm theo dõi
                            </a>
                        </div>
                        <div class="flex gap-2 ml-4">
                            <div class="group relative">
                                <input type="text" placeholder="Tìm kiếm..." id="customSearchInput"
                                    class="peer form-input ltr:pr-8 rtl:pl-8">
                                <div
                                    class="absolute top-1/2 -translate-y-1/2 peer-focus:text-primary ltr:right-[11px] rtl:left-[11px]">
                                    <svg width="24" height="24" viewbox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg" class="h-4 w-4">
                                        <circle cx="11.5" cy="11.5" r="9.5" stroke="currentColor" stroke-width="1.5"
                                            opacity="0.5"></circle>
                                        <path d="M18.5 18.5L22 22" stroke="currentColor" stroke-width="1.5"
                                            stroke-linecap="round"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex w-1/2 flex-col gap-4 sm:w-auto sm:flex-row sm:items-center sm:gap-3">
                        <div class="flex gap-3">
                            <button type="button" class="btn btn-primary gap-2" @@click="print">
                                <svg width="24" height="24" viewbox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg" class="h-5 w-5">
                                    <path
                                        d="M6 17.9827C4.44655 17.9359 3.51998 17.7626 2.87868 17.1213C2 16.2426 2 14.8284 2 12C2 9.17157 2 7.75736 2.87868 6.87868C3.75736 6 5.17157 6 8 6H16C18.8284 6 20.2426 6 21.1213 6.87868C22 7.75736 22 9.17157 22 12C22 14.8284 22 16.2426 21.1213 17.1213C20.48 17.7626 19.5535 17.9359 18 17.9827"
                                        stroke="currentColor" stroke-width="1.5"></path>
                                    <path opacity="0.5" d="M9 10H6" stroke="currentColor" stroke-width="1.5"
                                        stroke-linecap="round"></path>
                                    <path d="M19 14L5 14" stroke="currentColor" stroke-width="1.5"
                                        stroke-linecap="round"></path>
                                    <path
                                        d="M18 14V16C18 18.8284 18 20.2426 17.1213 21.1213C16.2426 22 14.8284 22 12 22C9.17157 22 7.75736 22 6.87868 21.1213C6 20.2426 6 18.8284 6 16V14"
                                        stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                                    <path opacity="0.5"
                                        d="M17.9827 6C17.9359 4.44655 17.7626 3.51998 17.1213 2.87868C16.2427 2 14.8284 2 12 2C9.17158 2 7.75737 2 6.87869 2.87868C6.23739 3.51998 6.06414 4.44655 6.01733 6"
                                        stroke="currentColor" stroke-width="1.5"></path>
                                    <circle opacity="0.5" cx="17" cy="10" r="1" fill="currentColor"></circle>
                                    <path opacity="0.5" d="M15 16.5H9" stroke="currentColor" stroke-width="1.5"
                                        stroke-linecap="round"></path>
                                    <path opacity="0.5" d="M13 19H9" stroke="currentColor" stroke-width="1.5"
                                        stroke-linecap="round"></path>
                                </svg>
                                In
                            </button>
                            <button type="button" class="btn btn-success gap-2">
                                <svg width="24" height="24" viewbox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg" class="h-5 w-5">
                                    <path opacity="0.5"
                                        d="M17 9.00195C19.175 9.01406 20.3529 9.11051 21.1213 9.8789C22 10.7576 22 12.1718 22 15.0002V16.0002C22 18.8286 22 20.2429 21.1213 21.1215C20.2426 22.0002 18.8284 22.0002 16 22.0002H8C5.17157 22.0002 3.75736 22.0002 2.87868 21.1215C2 20.2429 2 18.8286 2 16.0002L2 15.0002C2 12.1718 2 10.7576 2.87868 9.87889C3.64706 9.11051 4.82497 9.01406 7 9.00195"
                                        stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                                    <path d="M12 2L12 15M12 15L9 11.5M12 15L15 11.5" stroke="currentColor"
                                        stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                </svg>
                                Tải xuống
                            </button>
                        </div>
                    </div>
                </div>
                <!-- FILTER BAR START -->
                <div class="flex flex-col lg:flex-row gap-6">
                    <div class="w-auto mx-auto p-4 rounded-lg">
                        <div class="flex flex-col sm:flex-row gap-5 mb-4 justify-center items-center">
                            <div class="w-48">
                                <input id="filterDate" type="text"
                                    class="filter-input filter-bar-item form-input w-full mt-1 p-2 border rounded flatpickr"
                                    placeholder="Chọn ngày theo dõi..." autocomplete="off" />
                            </div>
                            <div class="w-48">
                                <div class="select-wrapper">
                                    <select id="filterPatient"
                                        class="filter-input filter-bar-item form-input w-full mt-1 p-2 border rounded choices"
                                        placeholder="Chọn bệnh nhân..."></select>
                                </div>
                            </div>
                            <div class="w-48">
                                <div class="select-wrapper">
                                    <select id="filterStatus"
                                        class="filter-input filter-bar-item w-full mt-1 p-2 border rounded choices"
                                        placeholder="Chọn trạng thái..."></select>
                                </div>
                            </div>
                            <div class="w-32">
                                <button id="btnFilter" type="button"
                                    class="btn btn-primary filter-bar-item w-full mr-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-2" width="20"
                                        height="20" fill="none" viewBox="0 0 24 24">
                                        <path d="M4 5h16M6 10h12M9 15h6M10 20h4" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" />
                                    </svg>
                                    Lọc
                                </button>
                            </div>
                            <div class="w-32">
                                <button id="btnResetFilter" type="button"
                                    class="btn btn-secondary filter-bar-item w-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-2" width="18"
                                        height="18" fill="none" viewBox="0 0 24 24">
                                        <path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" />
                                    </svg>
                                    Hủy lọc
                                </button>
                            </div>
                            <div class="w-40">
                                <button id="btnAdvancedFilter" type="button"
                                    class="btn btn-info filter-bar-item w-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-2" width="20"
                                        height="20" fill="none" viewBox="0 0 24 24">
                                        <path d="M3 5h18M6 9h12M9 13h6M10.5 17h3" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" />
                                        <path d="M8 21h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            opacity="0.5" />
                                    </svg>
                                    Lọc nâng cao
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- FILTER BAR END -->
                <div id="advancedFilter" class="flex justify-center gap-4" style="display:none;">
                    <div>
                        <input id="filterDateFrom" type="text" class="form-input flatpickr w-56"
                            placeholder="Từ ngày..." autocomplete="off" />
                    </div>
                    <div>
                        <input id="filterDateTo" type="text" class="form-input flatpickr w-56" placeholder="Đến ngày..."
                            autocomplete="off" />
                    </div>
                </div>
                <div class="table-responsive">
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table id="myTable" class="table-striped table-hover"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<div id="trackingModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-5xl p-6 relative modal-content-animate">
        <div id="modalRoomTitle" class="text-2xl font-bold text-green-700 text-center mb-4"></div>
        <div style="max-height: 400px; overflow-y: auto;">
            <div style="max-height: 400px; overflow-y: auto;">
                <table class="w-full text-center mb-4">
                    <thead>
                        <tr>
                            <th style="text-align:center; font-weight: bold;">STT</th>
                            <th style="text-align:center; font-weight: bold;">Tên bệnh nhân</th>
                            <th style="text-align:center; font-weight: bold;">Trạng thái</th>
                            <th style="text-align:center; font-weight: bold;">Ghi chú</th>
                            <th style="text-align:center; font-weight: bold;">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="modalPatientTableBody"></tbody>
                </table>
            </div>
        </div>
        <div class="flex justify-center">
            <button id="closeTrackingModal" class="btn btn-secondary px-8 py-2 text-base">Đóng</button>
        </div>
    </div>
</div>

<div id="editTrackingModal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-modal-blur">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-5xl p-6 relative modal-content-animate">
        <div id="editModalRoomTitle" class="text-2xl font-bold text-green-700 text-center mb-4"></div>
        <table class="w-full text-center mb-4">
            <thead>
                <tr>
                    <th style="text-align:center; font-weight: bold;">Tên bệnh nhân</th>
                    <th style="text-align:center; font-weight: bold;">Trạng thái</th>
                    <th style="text-align:center; font-weight: bold;">Ghi chú</th>
                    <th style="text-align:center; font-weight: bold;">Thao tác</th>
                </tr>
            </thead>
            <tbody id="editModalPatientTableBody"></tbody>
        </table>
        <div class="flex justify-center">
            <button id="closeEditTrackingModal" class="btn btn-secondary px-8 py-2 text-base">Đóng</button>
        </div>
    </div>
</div>

<script>

    document.addEventListener('alpine:init', () => {
        Alpine.data('list', () => ({
            entityList: @Html.Raw(Json.Serialize(Model)),
            filteredList: [],
            selectedRows: [],
            datatable: null,

            init() {
                if (!Array.isArray(this.entityList)) {
                    this.entityList = [];
                }
                this.filteredList = [...this.entityList];
                window.entityList = this.entityList;
                window.list = this;
                this.initializeTable();

                document.querySelector('#myTable thead').addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        this.selectedRows = [];
                        const checkboxes = document.querySelectorAll('#myTable tbody input[type="checkbox"]');
                        checkboxes.forEach(checkbox => {
                            checkbox.checked = e.target.checked;
                            if (e.target.checked) {
                                if (!this.selectedRows.includes(checkbox.value)) {
                                    this.selectedRows.push(checkbox.value);
                                }
                            }
                        });
                    }
                });

                document.querySelector('#myTable tbody').addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        const checkbox = e.target;
                        const id = checkbox.value;
                        if (checkbox.checked) {
                            if (!this.selectedRows.includes(id)) {
                                this.selectedRows.push(id);
                            }
                        } else {
                            this.selectedRows = this.selectedRows.filter(rowId => rowId !== id);
                        }
                        const allCheckboxes = document.querySelectorAll('#myTable tbody input[type="checkbox"]');
                        const allChecked = Array.from(allCheckboxes).every(chk => chk.checked);
                        const mainCheckbox = document.querySelector('#myTable thead input[type="checkbox"]');
                        mainCheckbox.checked = allChecked;
                    }
                });

                document.querySelector('#myTable tbody').addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.delete-btn');
                    if (deleteBtn) {
                        const id = deleteBtn.getAttribute('data-id');
                        this.moveSingleToTrash(id);
                    }
                });
            },

            initializeTable() {
                const tableData = this.filteredList.map(entity => [
                    `<input type="checkbox" class="form-checkbox" value="${entity.id}" />`,
                    entity.code,
                    entity.patientName,
                    new Date(entity.trackingDate).toLocaleDateString('vi-VN'),
                    this.getTrackingStatusBadge(entity.status),
                    `<div class="flex gap-4">
                        <a href="javascript:;" 
                           class="edit-btn" 
                           data-id="${entity.id}" 
                           data-status="${entity.status}" 
                           data-note="${entity.note || ''}" 
                           data-doctor-code="${entity.doctorCode}">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-4.5 h-4.5">
                                <path opacity="0.5" d="M22 10.5V12C22 16.714 22 19.0711 20.5355 20.5355C19.0711 22 16.714 22 12 22C7.28595 22 4.92893 22 3.46447 20.5355C2 19.0711 2 16.714 2 12C2 7.28595 2 4.92893 3.46447 3.46447C4.92893 2 7.28595 2 12 2H13.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                                <path d="M17.3009 2.80624L16.652 3.45506L10.6872 9.41993C10.2832 9.82394 10.0812 10.0259 9.90743 10.2487C9.70249 10.5114 9.52679 10.7957 9.38344 11.0965C9.26191 11.3515 9.17157 11.6225 8.99089 12.1646L8.41242 13.9L8.03811 15.0229C7.9492 15.2897 8.01862 15.5837 8.21744 15.7826C8.41626 15.9814 8.71035 16.0508 8.97709 15.9619L10.1 15.5876L11.8354 15.0091C12.3775 14.8284 12.6485 14.7381 12.9035 14.6166C13.2043 14.4732 13.4886 14.2975 13.7513 14.0926C13.9741 13.9188 14.1761 13.7168 14.5801 13.3128L20.5449 7.34795L21.1938 6.69914C22.2687 5.62415 22.2687 3.88124 21.1938 2.80624C20.1188 1.73125 18.3759 1.73125 17.3009 2.80624Z" stroke="currentColor" stroke-width="1.5"></path>
                                <path opacity="0.5" d="M16.6522 3.45508C16.6522 3.45508 16.7333 4.83381 17.9499 6.05034C19.1664 7.26687 20.5451 7.34797 20.5451 7.34797M10.1002 15.5876L8.4126 13.9" stroke="currentColor" stroke-width="1.5"></path>
                            </svg>
                        </a>
                    </div>`
                ]);

                this.datatable = new simpleDatatables.DataTable('#myTable', {
                    data: {
                        headings: [
                            '<input type="checkbox" class="form-checkbox" />',
                            'Mã theo dõi điều trị',
                            'Tên bệnh nhân',
                            'Ngày theo dõi',
                            'Trạng thái',
                            'Thao tác'
                        ],
                        data: tableData
                    },
                    perPage: 10,
                    perPageSelect: [10, 20, 30, 50, 100],
                    firstLast: true,
                    searchable: false,
                    firstText: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-4.5 h-4.5 rtl:rotate-180"><path d="M13 19L7 12L13 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path opacity="0.5" d="M16.9998 19L10.9998 12L16.9998 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                    lastText: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-4.5 h-4.5 rtl:rotate-180"><path d="M11 19L17 12L11 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path opacity="0.5" d="M6.99976 19L12.9998 12L6.99976 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                    prevText: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-4.5 h-4.5 rtl:rotate-180"><path d="M15 5L9 12L15 19" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                    nextText: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-4.5 h-4.5 rtl:rotate-180"><path d="M9 5L15 12L9 19" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                    labels: {
                        perPage: "<span class='ml-2'>{select}</span>",
                        noRows: 'Không có dữ liệu'
                    },
                    layout: {
                        top: '{search}',
                        bottom: '{info}{select}{pager}'
                    },
                    columns: [
                        {
                            select: 0,
                            sortable: false,
                            render: (data, cell, row) => {
                                return data;
                            }
                        },
                        {
                            select: 4,
                            sortable: false,
                            render: (data, cell, row) => {
                                return data;
                            }
                        },
                        {
                            select: 5,
                            sortable: false,
                            render: (data, cell, row) => {
                                return data;
                            }
                        }
                    ],
                });
            },

            moveToTrash() {
                if (this.selectedRows.length === 0) {
                    notyf.error('Vui lòng chọn ít nhất một theo dõi điều trị để đưa vào thùng rác.');
                    return;
                }

                $.confirm({
                    title: 'Bạn có chắc chắn?',
                    content: 'Bạn có muốn đưa các theo dõi điều trị vào thùng rác không?',
                    icon: 'fa fa-question-circle text-blue-500',
                    theme: 'modern',
                    type: 'blue',
                    boxWidth: '400px',
                    useBootstrap: false,
                    buttons: {
                        confirm: {
                            text: 'Có, hãy thực hiện!',
                            btnClass: 'btn-success',
                            action: () => {
                                document.getElementById('selectedIds').value = this.selectedRows.join(',');
                                document.getElementById('indexForm').submit();
                            }
                        },
                        cancel: {
                            text: 'Hủy',
                            btnClass: 'btn-secondary'
                        }
                    }
                });
            },

            moveSingleToTrash(id) {
                $.confirm({
                    title: 'Bạn có chắc chắn?',
                    content: 'Bạn có muốn đưa theo dõi điều trị này vào thùng rác không?',
                    icon: 'fa fa-question-circle text-blue-500',
                    theme: 'modern',
                    type: 'blue',
                    boxWidth: '400px',
                    useBootstrap: false,
                    buttons: {
                        confirm: {
                            text: 'Có, hãy thực hiện!',
                            btnClass: 'btn-success',
                            action: () => {
                                document.getElementById('selectedIds').value = id;
                                document.getElementById('indexForm').submit();
                            }
                        },
                        cancel: {
                            text: 'Hủy',
                            btnClass: 'btn-secondary'
                        }
                    }
                });
            },

            openTrackingModal() {
                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const year = today.getFullYear();
                const dateStr = `${year}-${month}-${day}`;

                $('#trackingModal').removeClass('hidden closing');
                $('.modal-content-animate', '#trackingModal').removeClass('animate__fadeOut');
                $('#modalRoomTitle').html(`Ngày ${day}/${month}/${year} – Phòng ...`);

                $.get('/api/trackings/room-name', function (data) {
                    $('#modalRoomTitle').html(`Ngày ${day}/${month}/${year} – Phòng ${data.roomName}`);
                    $('#trackingModal').data('room-id', data.roomId);
                });

                $.get(`/api/trackings/patients-in-room?date=${dateStr}`, function (patients) {
                    let rows = '';
                    if (patients.length === 0) {
                        rows = `<tr><td colspan="5" style="text-align:center;color:#888;font-style:italic;">Không còn bệnh nhân nào cần chấm theo dõi trong ngày hôm nay</td></tr>`;
                    } else {
                        patients.forEach((patient, idx) => {
                            rows += `
                                <tr data-patient-name="${patient.name}" data-patient-id="${patient.id}">
                                    <td>${idx + 1}</td>
                                    <td>${patient.name}</td>
                                    <td>
                                        <div class="btn-group d-flex justify-content-center" style="display:flex;gap:8px;">
                                            <button class="btn btn-success btn-status" data-status="1">Có khám</button>
                                            <button class="btn btn-warning btn-status" data-status="2">Xin phép</button>
                                            <button class="btn btn-danger btn-status" data-status="3">Không khám</button>
                                        </div>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control note-input" placeholder="Nhập ghi chú..." />
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-save">Lưu</button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                    $('#modalPatientTableBody').html(rows);
                });
            },

            getTrackingStatusBadge(status) {
                let text = getEnumDisplayName('TrackingStatus', status);
                let style = '';
                switch (status) {
                    case 1: // Có khám
                        style = 'background:#22c55e;color:white;'; // xanh lá cây
                        break;
                    case 2: // Xin phép
                        style = 'background:#f59e42;color:white;'; // vàng cam
                        break;
                    case 3: // Không khám
                        style = 'background:#ef4444;color:white;'; // đỏ
                        break;
                    default:
                        style = 'background:#a3a3a3;color:white;'; // xám
                }
                return `<span style="display:inline-block;min-width:80px;text-align:center;${style}border-radius:6px;padding:4px 12px;font-size:13px;font-weight:bold;">${text}</span>`;
            },

            filterList(patient, date, status, dateFrom, dateTo, showNotyf = true) {
                let filtered = this.entityList;
                if (patient) {
                    filtered = filtered.filter(e => e.patientName === patient);
                }
                if (date) {
                    const [d, m, y] = date.split('/');
                    const filterDate = new Date(`${y}-${m}-${d}`).toISOString().slice(0, 10);
                    filtered = filtered.filter(e => {
                        const entityDate = new Date(e.trackingDate).toISOString().slice(0, 10);
                        return entityDate === filterDate;
                    });
                }
                if (status) {
                    filtered = filtered.filter(e => String(e.status) === String(status));
                }
                if (dateFrom || dateTo) {
                    filtered = filtered.filter(e => {
                        const entityDate = new Date(e.trackingDate);
                        const entityDateStr = entityDate.toISOString().slice(0, 10);
                        let fromStr = dateFrom ? dateFrom.split('/').reverse().join('-') : null;
                        let toStr = dateTo ? dateTo.split('/').reverse().join('-') : null;
                        if (fromStr && entityDateStr < fromStr) return false;
                        if (toStr && entityDateStr > toStr) return false;
                        return true;
                    });
                }
                this.filteredList = filtered;
                if (this.datatable) {
                    this.datatable.destroy();
                }
                this.initializeTable();
                if (showNotyf && filtered.length > 0) {
                    notyf.success('Lọc thành công!');
                }
            }
        }));
    });
</script>

@if (TempData["SuccessMessage"] != null)
{
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            notyf.success('@Html.Raw(TempData["SuccessMessage"])');
        });
    </script>
}
@if (TempData["ErrorMessage"] != null)
{
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            notyf.error('@Html.Raw(TempData["ErrorMessage"])');
        });
    </script>
}

<style>
    .btn-status.active-status {
        filter: none;
        opacity: 1;
        box-shadow: 0 0 0 2px #3333;
        font-weight: bold;
    }

    .btn-status:not(.active-status) {
        opacity: 0.5;
        filter: grayscale(30%);
    }

    #trackingModal {
        background: rgba(30, 41, 59, 0.2);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
    }

    /* Hiệu ứng mở (fade + scale) */
    @@keyframes modalFadeIn
    {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @@keyframes modalFadeOut
        {
                from {
                    opacity: 1;
                    transform: scale(1);
                }

                to {
                    opacity: 0;
                    transform: scale(0.95);
                }
            }

            #trackingModal .modal-content-animate {
                animation: modalFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            #trackingModal.closing .modal-content-animate {
                animation: modalFadeOut 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            }

            #editTrackingModal .modal-content-animate {
                animation: modalFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            #editTrackingModal.closing .modal-content-animate {
                animation: modalFadeOut 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            }

            /* Nền mờ xung quanh modal */
            .bg-modal-blur {
                background: rgba(30, 41, 59, 0.2);
                backdrop-filter: blur(6px);
                -webkit-backdrop-filter: blur(6px);
            }

            .note-input {
                border: 2px solid #a3a3a3;
                border-radius: 8px;
                padding: 6px 14px;
                transition: border-color 0.2s, box-shadow 0.2s;
                outline: none;
                box-shadow: none;
            }

            .note-input:focus {
                border-color: #22c55e;
                /* xanh lá khi focus */
                box-shadow: 0 0 0 2px #22c55e33;
                background: #f6fff8;
            }

            .filter-bar-item {
                height: 40px !important;
                min-height: 40px !important;
                padding-top: 0.375rem !important;
                padding-bottom: 0.375rem !important;
                box-sizing: border-box;
            }

            .filter-bar-container {
                flex-wrap: nowrap !important;
                justify-content: center;
                gap: 24px;
            }

            .filter-bar-container>* {
                flex: 0 0 auto !important;
            }

            #filterPatient+.choices,
            #filterStatus+.choices {
                width: 260px !important;
                min-width: 260px !important;
                max-width: 260px !important;
                flex: none !important;
            }

            #filterPatient+.choices .choices__inner,
            #filterStatus+.choices .choices__inner {
                width: 100% !important;
                min-width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box;
            }

            input:disabled {
                cursor: not-allowed;
                background: #f3f4f6 !important;
                color: #a3a3a3 !important;
            }
        </style>

        <script>
            $(document).on('click', '.btn-status', function () {
                var $row = $(this).closest('tr');
                if ($(this).hasClass('active-status')) {
                    // Nếu đã active thì bỏ chọn
                    $(this).removeClass('active-status');
                } else {
                    // Nếu chưa active thì chuyển active
                    $row.find('.btn-status').removeClass('active-status');
                    $(this).addClass('active-status');
                }
            });
        </script>

        <script>
            $(document).on('click', '.btn-save', function (e) {
                e.preventDefault();
                var $row = $(this).closest('tr');
                var patientId = $row.data('patient-id');
                var roomId = $('#trackingModal').data('room-id');
                var statusBtn = $row.find('.btn-status.active-status');
                if (statusBtn.length === 0) {
                    notyf.error('Vui lòng chọn trạng thái!');
                    return;
                }
                var status = statusBtn.data('status');
                var note = $row.find('.note-input').val();
                var trackingDate = new Date().toISOString();

                fetch('/api/trackings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        patientId: patientId,
                        roomId: roomId,
                        status: status,
                        note: note,
                        trackingDate: trackingDate
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success !== false) {
                            notyf.success('Lưu thành công!');
                            // Xóa dòng bệnh nhân vừa lưu khỏi bảng
                            $row.remove();
                            // Cập nhật lại số thứ tự (STT)
                            $('#modalPatientTableBody tr').each(function (index) {
                                $(this).find('td').eq(0).text(index + 1);
                            });
                            // Nếu không còn bệnh nhân nào, hiển thị dòng thông báo
                            if ($('#modalPatientTableBody tr').length === 0) {
                                $('#modalPatientTableBody').html(
                                    `<tr><td colspan="5" style="text-align:center;color:#888;font-style:italic;">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Không còn bệnh nhân nào cần chấm theo dõi trong ngày hôm nay
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr>`
                                );
                            }
                        } else {
                            notyf.error(data.message || 'Lưu thất bại!');
                        }
                    })
                    .catch(() => {
                        notyf.error('Có lỗi khi gửi dữ liệu!');
                    });
            });
        </script>

        <script>
            $(document).on('click', '#closeTrackingModal', function () {
                $('#trackingModal').addClass('closing');
                setTimeout(function () {
                    $('#trackingModal').addClass('hidden').removeClass('closing');
                    // Reload lại trang sau khi modal đóng
                    window.location.reload();
                }, 200); // Thời gian trùng với animation out
            });
        </script>

        <script>
            let currentEditId = null;
            const currentEmployeeCode = '@ViewBag.CurrentEmployeeCode'.trim();

            $(document).on('click', '.edit-btn', function () {
                const doctorCode = ($(this).data('doctor-code') + '').trim();
                const empCode = (currentEmployeeCode + '').trim();
                if (doctorCode !== empCode) {
                    notyf.error('Bạn không có quyền cập nhật bản ghi này');
                    return;
                }
                // Lấy dữ liệu từ entityList (hoặc data attribute)
                const id = $(this).data('id');
                const entity = window.entityList?.find(e => e.id === id);
                currentEditId = id;

                // Set tiêu đề phòng
                $('#editModalRoomTitle').text(entity ? `Ngày ${new Date(entity.trackingDate).toLocaleDateString('vi-VN')} – Phòng ${entity.roomName}` : '');

                // Set trạng thái, tên bệnh nhân, ghi chú
                $('#editModalPatientTableBody').empty();
                $('#editModalPatientTableBody').append(`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <td style="font-weight:bold;">${entity ? entity.patientName : ''}</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <td style="text-align:center;">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="btn-group d-flex justify-center" style="display:flex;gap:12px;justify-content:center;">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <button class="btn btn-success btn-status${entity && entity.status == 1 ? ' active-status' : ''}" data-status="1">Có khám</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <button class="btn btn-warning btn-status${entity && entity.status == 2 ? ' active-status' : ''}" data-status="2">Xin phép</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <button class="btn btn-danger btn-status${entity && entity.status == 3 ? ' active-status' : ''}" data-status="3">Không khám</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <td style="text-align:center;">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <input type="text" class="form-control note-input" placeholder="Nhập ghi chú..." value="${entity && entity.note ? entity.note.replace(/\"/g, '&quot;') : ''}" style="width: 220px; margin: 0 auto;" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <td style="text-align:center;">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <button class="btn btn-primary btn-update">Cập nhật</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                `);

                $('#editTrackingModal').removeClass('hidden closing');
            });

            // Chọn trạng thái
            $('#editTrackingModal .btn-status').on('click', function () {
                $('#editTrackingModal .btn-status').removeClass('active-status');
                $(this).addClass('active-status');
            });

            // Đóng modal với hiệu ứng
            $('#closeEditTrackingModal').on('click', function () {
                $('#editTrackingModal').addClass('closing');
                setTimeout(function () {
                    $('#editTrackingModal').addClass('hidden').removeClass('closing');
                    window.location.reload();
                }, 200);
            });

            // Submit cập nhật
            $(document).on('click', '#editModalPatientTableBody .btn-update', function (e) {
                e.preventDefault();

                const $btn = $(this);
                if ($btn.prop('disabled')) return;

                $btn.prop('disabled', true);

                const $row = $(this).closest('tr');
                const status = $row.find('.btn-status.active-status').data('status');
                const note = $row.find('.note-input').val();

                if (!status) {
                    notyf.error('Vui lòng chọn trạng thái!');
                    return;
                }

                fetch('/api/trackings/' + currentEditId, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({ status, note })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            notyf.success('Cập nhật thành công!');
                        } else {
                            notyf.error(data.message || 'Cập nhật thất bại!');
                        }
                    })
                    .catch(() => notyf.error('Có lỗi khi gửi dữ liệu!'));
            });
        </script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Lấy danh sách bệnh nhân duy nhất
                const entityList = window.entityList || [];
                const patientNames = [...new Set(entityList.map(e => e.patientName).filter(Boolean))];
                const patientSelect = document.getElementById('filterPatient');
                patientSelect.innerHTML = '<option value="">Chọn bệnh nhân...</option>' +
                    patientNames.map(name => `<option value="${name}">${name}</option>`).join('');

                // Đổ option cho trạng thái
                const statusSelect = document.getElementById('filterStatus');
                const statusOptions = [
                    { value: '', text: 'Chọn trạng thái...' },
                    { value: 1, text: 'Có khám' },
                    { value: 2, text: 'Xin phép' },
                    { value: 3, text: 'Không khám' }
                ];
                statusSelect.innerHTML = statusOptions.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('');

                if (window.flatpickr) {
                    flatpickr("#filterDate", {
                        dateFormat: "d/m/Y",
                        allowInput: true,
                    });
                    flatpickr("#filterDateFrom", {
                        dateFormat: "d/m/Y",
                        allowInput: true,
                    });
                    flatpickr("#filterDateTo", {
                        dateFormat: "d/m/Y",
                        allowInput: true,
                    });
                }

                // Chỉ khởi tạo Choices.js sau khi đã đổ option xong và chưa có instance
                if (window.Choices) {
                    if (!patientSelect.classList.contains('choices-initialized')) {
                        window.patientChoices = new Choices(patientSelect, {
                            searchEnabled: true,
                            searchPlaceholderValue: 'Tìm kiếm...',
                            removeItemButton: true,
                            noResultsText: 'Không tìm thấy kết quả',
                            noChoicesText: 'Không có lựa chọn nào',
                            itemSelectText: ''
                        });
                        patientSelect.classList.add('choices-initialized');
                    }
                    if (!statusSelect.classList.contains('choices-initialized')) {
                        window.statusChoices = new Choices(statusSelect, {
                            searchEnabled: true,
                            searchPlaceholderValue: 'Tìm kiếm...',
                            removeItemButton: true,
                            noResultsText: 'Không tìm thấy kết quả',
                            noChoicesText: 'Không có lựa chọn nào',
                            itemSelectText: ''
                        });
                        statusSelect.classList.add('choices-initialized');
                    }
                    setTimeout(function () {
                        document.querySelectorAll('#filterPatient + .choices, #filterStatus + .choices').forEach(el => {
                            el.style.width = '260px';
                            el.style.minWidth = '260px';
                            el.style.maxWidth = '260px';
                            el.style.flex = 'none';
                        });
                        document.querySelectorAll('#filterPatient + .choices .choices__inner, #filterStatus + .choices .choices__inner').forEach(el => {
                            el.style.width = '100%';
                            el.style.minWidth = '100%';
                            el.style.maxWidth = '100%';
                        });
                    }, 200);
                }
            });
        </script>

        <script>
            // Lọc danh sách khi nhấn nút Lọc
            $(document).on('click', '#btnFilter', function () {
                const patient = $('#filterPatient').val();
                const date = $('#filterDate').val();
                const status = $('#filterStatus').val();
                const dateFrom = $('#filterDateFrom').val();
                const dateTo = $('#filterDateTo').val();

                // Nếu chỉ nhập 1 trong 2 trường khoảng ngày thì báo lỗi
                if ((dateFrom && !dateTo) || (!dateFrom && dateTo)) {
                    notyf.error('Vui lòng chọn đầy đủ khoảng thời gian khi lọc nâng cao!');
                    return;
                }

                // Nếu nhập đủ cả 2 trường thì kiểm tra logic ngày
                if (dateFrom && dateTo) {
                    // Chuyển về dạng yyyy-mm-dd để so sánh
                    const fromParts = dateFrom.split('/');
                    const toParts = dateTo.split('/');
                    const fromDate = new Date(`${fromParts[2]}-${fromParts[1]}-${fromParts[0]}`);
                    const toDate = new Date(`${toParts[2]}-${toParts[1]}-${toParts[0]}`);
                    if (fromDate > toDate) {
                        notyf.error('Khoảng thời gian để lọc không hợp lệ!');
                        return;
                    }
                }

                // Nếu không có trường nào được chọn
                if (!patient && !date && !status && !dateFrom && !dateTo) {
                    notyf.error('Cần chọn ít nhất một trường để lọc!');
                    return;
                }
                if (window.list && typeof window.list.filterList === 'function') {
                    window.list.filterList(patient, date, status, dateFrom, dateTo);
                }
            });
        </script>

        <script>
            function updateResetFilterButtonState() {
                const patient = $('#filterPatient').val();
                const date = $('#filterDate').val();
                const status = $('#filterStatus').val();
                const dateFrom = $('#filterDateFrom').val();
                const dateTo = $('#filterDateTo').val();
                if (!patient && !date && !status && !dateFrom && !dateTo) {
                    $('#btnResetFilter').prop('disabled', true).css('cursor', 'not-allowed');
                } else {
                    $('#btnResetFilter').prop('disabled', false).css('cursor', 'pointer');
                }
            }
            $(document).ready(function () {
                updateResetFilterButtonState();
                $('#filterPatient, #filterDate, #filterStatus, #filterDateFrom, #filterDateTo').on('change input', function () {
                    updateResetFilterButtonState();
                });
            });
            $(document).on('click', '#btnResetFilter', function () {
                // Reset input ngày đơn
                $('#filterDate').val('');
                // Reset input khoảng ngày
                $('#filterDateFrom').val('');
                $('#filterDateTo').val('');

                // Reset Choices.js cho select bệnh nhân và trạng thái
                if (window.patientChoices) {
                    window.patientChoices.removeActiveItems();
                    window.patientChoices.setChoiceByValue('');
                } else {
                    $('#filterPatient').val('').trigger('change');
                }
                if (window.statusChoices) {
                    window.statusChoices.removeActiveItems();
                    window.statusChoices.setChoiceByValue('');
                } else {
                    $('#filterStatus').val('').trigger('change');
                }

                if (window.list && typeof window.list.filterList === 'function') {
                    window.list.filterList('', '', '', '', '', false);
                }
                updateResetFilterButtonState();
            });
        </script>

        <script>
            // Toggle advanced filter
            $(document).on('click', '#btnAdvancedFilter', function () {
                $('#advancedFilter').slideToggle(150);

                setTimeout(function () {
                    if ($('#advancedFilter').is(':visible')) {
                        // Khi bật lọc nâng cao: disable và xóa giá trị ngày đơn
                        $('#filterDate').val('').prop('disabled', true);

                        // Khởi tạo lại flatpickr cho 2 input nếu chưa có
                        if (!$('#filterDateFrom').hasClass('flatpickr-input')) {
                            flatpickr("#filterDateFrom", {
                                dateFormat: "d/m/Y",
                                allowInput: true,
                            });
                        }
                        if (!$('#filterDateTo').hasClass('flatpickr-input')) {
                            flatpickr("#filterDateTo", {
                                dateFormat: "d/m/Y",
                                allowInput: true,
                            });
                        }
                    } else {
                        // Khi tắt lọc nâng cao: enable lại ngày đơn
                        $('#filterDate').prop('disabled', false);
                    }
                }, 160); // slideToggle 150ms, nên để 160ms
            });
        </script>

        <script>
            $('#filterDate').on('change', function () {
                if ($(this).val()) {
                    $('#filterDateFrom').val('');
                    $('#filterDateTo').val('');
                }
            });
        </script>

        <script>
            $(document).on('click', '#customSearchBtn', function () {
                const keyword = $('#customSearchInput').val().toLowerCase().trim();
                if (window.list) {
                    // Lọc trên filteredList hiện tại hoặc entityList gốc
                    let filtered = window.list.entityList.filter(e =>
                        (e.code && e.code.toLowerCase().includes(keyword)) ||
                        (e.patientName && e.patientName.toLowerCase().includes(keyword)) ||
                        (e.trackingDate && new Date(e.trackingDate).toLocaleDateString('vi-VN').includes(keyword)) ||
                        (e.status && getEnumDisplayName('TrackingStatus', e.status).toLowerCase().includes(keyword))
                    );
                    window.list.filteredList = filtered;
                    if (window.list.datatable) window.list.datatable.destroy();
                    window.list.initializeTable();
                }
            });
        </script>

        <script>
            $('#customSearchInput').on('input', function () {
                const keyword = $(this).val().toLowerCase().trim();
                if (window.list) {
                    let filtered = window.list.entityList.filter(e =>
                        (e.code && e.code.toLowerCase().includes(keyword)) ||
                        (e.patientName && e.patientName.toLowerCase().includes(keyword)) ||
                        (e.trackingDate && new Date(e.trackingDate).toLocaleDateString('vi-VN').includes(keyword)) ||
                        (e.status && getEnumDisplayName('TrackingStatus', e.status).toLowerCase().includes(keyword))
                    );
                    window.list.filteredList = filtered;
                    if (window.list.datatable) window.list.datatable.destroy();
                    window.list.initializeTable();
                }
            });
        </script>